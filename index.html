<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Karapatan Pinoy - Philippine Legal Assistant</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { 
            font-family: -apple-system, BlinkMacSystemFont, sans-serif; 
            background: linear-gradient(135deg, #1a237e 0%, #283593 100%);
            min-height: 100vh;
            padding: 15px;
            font-size: 16px;
        }
        
        .container {
            max-width: 100%;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.2);
            overflow: hidden;
        }
        
        .header {
            background: linear-gradient(135deg, #d32f2f 0%, #b71c1c 100%);
            color: white;
            padding: 25px 20px;
            text-align: center;
            border-bottom: 5px solid #ffd700;
        }
        
        .header h1 {
            font-size: 1.8rem;
            margin: 0;
            font-weight: 700;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }
        
        .header .subtitle {
            margin-top: 8px;
            font-size: 1rem;
            opacity: 0.9;
        }
        
        .stats-bar {
            background: #f5f5f5;
            padding: 12px 20px;
            border-bottom: 1px solid #e0e0e0;
            display: flex;
            justify-content: space-between;
            font-size: 0.85rem;
            color: #666;
            flex-wrap: wrap;
        }
        
        .main-content {
            padding: 20px;
        }
        
        /* Expandable Sections */
        .expandable-section {
            margin-bottom: 20px;
            border-radius: 12px;
            overflow: hidden;
            border: 1px solid #e0e0e0;
        }
        
        .section-header {
            background: #f8f9fa;
            padding: 18px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            cursor: pointer;
            border-bottom: 1px solid #e0e0e0;
        }
        
        .section-header h3 {
            color: #d32f2f;
            margin: 0;
            font-size: 1.1rem;
            font-weight: 600;
        }
        
        .toggle-arrow {
            font-size: 1.5rem;
            color: #666;
            transition: transform 0.3s;
        }
        
        .toggle-arrow.open {
            transform: rotate(180deg);
        }
        
        .section-content {
            padding: 0;
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s ease-out, padding 0.3s;
        }
        
        .section-content.open {
            padding: 20px;
            max-height: 2000px;
        }
        
        #apiKeyInput {
            width: 100%;
            padding: 15px;
            border: 2px solid #ddd;
            border-radius: 10px;
            margin: 15px 0;
            font-family: monospace;
            font-size: 1rem;
        }
        
        .connect-btn {
            width: 100%;
            padding: 16px;
            background: #d32f2f;
            color: white;
            border: none;
            border-radius: 10px;
            font-weight: 600;
            font-size: 1.1rem;
            cursor: pointer;
            margin-top: 10px;
        }
        
        .connect-btn.connected {
            background: #388e3c;
        }
        
        .connect-btn:disabled {
            background: #757575;
            cursor: not-allowed;
        }
        
        .status {
            padding: 15px;
            border-radius: 10px;
            margin: 15px 0;
            text-align: center;
            font-weight: 600;
            font-size: 1rem;
        }
        
        .status.connected { 
            background: #e8f5e9; 
            color: #1b5e20; 
            border: 2px solid #c8e6c9;
        }
        
        .status.disconnected { 
            background: #ffebee; 
            color: #c62828; 
            border: 2px solid #ffcdd2;
        }
        
        /* Chat Interface - WIDER for mobile */
        .chat-interface {
            background: white;
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 20px;
            border: 1px solid #e0e0e0;
        }
        
        #chatHistory {
            height: 350px;
            overflow-y: auto;
            padding: 15px;
            background: #fafafa;
            border-radius: 10px;
            margin-bottom: 15px;
            border: 1px solid #e0e0e0;
            font-size: 1rem;
            line-height: 1.5;
        }
        
        .message {
            margin-bottom: 20px;
            max-width: 100%;
        }
        
        .user-message {
            background: linear-gradient(135deg, #d32f2f 0%, #b71c1c 100%);
            color: white;
            padding: 15px;
            border-radius: 18px 18px 0 18px;
            margin-left: auto;
            max-width: 90%;
            word-wrap: break-word;
        }
        
        .ai-message {
            background: white;
            border: 1px solid #e0e0e0;
            padding: 15px;
            border-radius: 18px 18px 18px 0;
            max-width: 90%;
            word-wrap: break-word;
            line-height: 1.6;
        }
        
        .ai-message p {
            margin-bottom: 10px;
        }
        
        .ai-message strong {
            color: #d32f2f;
        }
        
        .input-area {
            display: flex;
            gap: 10px;
            margin-top: 15px;
        }
        
        #userInput {
            flex: 1;
            padding: 15px;
            border: 2px solid #ddd;
            border-radius: 12px;
            font-size: 1rem;
            min-height: 60px;
            resize: none;
            font-family: inherit;
            line-height: 1.4;
        }
        
        #sendButton {
            background: linear-gradient(135deg, #d32f2f 0%, #b71c1c 100%);
            color: white;
            border: none;
            border-radius: 12px;
            padding: 0 25px;
            font-weight: 600;
            font-size: 1rem;
            cursor: pointer;
            min-width: 80px;
        }
        
        #sendButton:disabled {
            background: #9e9e9e;
            cursor: not-allowed;
        }
        
        /* Laws Display */
        .law-category {
            margin-bottom: 15px;
        }
        
        .law-category h4 {
            color: #d84315;
            margin-bottom: 8px;
            font-size: 1rem;
            padding-bottom: 5px;
            border-bottom: 2px solid #ffcc80;
        }
        
        .law-titles {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
        }
        
        .law-title {
            background: white;
            padding: 8px 12px;
            border-radius: 6px;
            font-size: 0.9rem;
            color: #333;
            border: 1px solid #ffe0b2;
            flex: 1 1 calc(50% - 8px);
            min-width: calc(50% - 8px);
            box-sizing: border-box;
        }
        
        .footer {
            text-align: center;
            padding: 20px;
            color: #666;
            font-size: 0.9rem;
            border-top: 1px solid #e0e0e0;
            background: #f5f5f5;
        }
        
        .footer .powered-by {
            font-size: 1rem;
            font-weight: 600;
            color: #d32f2f;
            margin-bottom: 5px;
        }
        
        .footer .secured-by {
            font-size: 1.1rem;
            font-weight: 700;
            color: #388e3c;
            letter-spacing: 1px;
        }
        
        /* Mobile Optimizations */
        @media (max-width: 480px) {
            body {
                padding: 10px;
                font-size: 15px;
            }
            
            .header {
                padding: 20px 15px;
            }
            
            .header h1 {
                font-size: 1.6rem;
            }
            
            .main-content {
                padding: 15px;
            }
            
            #chatHistory {
                height: 300px;
                padding: 12px;
                font-size: 15px;
            }
            
            .message {
                margin-bottom: 15px;
            }
            
            .user-message, .ai-message {
                padding: 12px;
                max-width: 95%;
            }
            
            .input-area {
                flex-direction: column;
            }
            
            #sendButton {
                width: 100%;
                padding: 15px;
            }
            
            .law-title {
                flex: 1 1 100%;
                min-width: 100%;
            }
        }
        
        @media (min-width: 768px) {
            .container {
                max-width: 750px;
            }
            
            .law-title {
                flex: 1 1 calc(33.333% - 8px);
                min-width: calc(33.333% - 8px);
            }
        }
        
        /* Scrollbar styling */
        #chatHistory::-webkit-scrollbar {
            width: 8px;
        }
        
        #chatHistory::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 4px;
        }
        
        #chatHistory::-webkit-scrollbar-thumb {
            background: #d32f2f;
            border-radius: 4px;
        }
        
        #chatHistory::-webkit-scrollbar-thumb:hover {
            background: #b71c1c;
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Header -->
        <div class="header">
            <h1>Karapatan Pinoy</h1>
            <div class="subtitle">Your Philippine Legal Rights Assistant</div>
        </div>
        
        <!-- Stats Bar -->
        <div class="stats-bar">
            <div>üìö <span id="lawCount">0</span> Legal Provisions</div>
            <div>‚öñÔ∏è <span id="dbSize">0</span> KB Database</div>
            <div>üáµüá≠ Updated 2024</div>
        </div>
        
        <div class="main-content">
            <!-- Secure Connection (Expandable) -->
            <div class="expandable-section">
                <div class="section-header" onclick="toggleSection('apiSection')">
                    <h3>üîê Secure Connection Setup</h3>
                    <div class="toggle-arrow" id="apiArrow">‚ñº</div>
                </div>
                <div class="section-content" id="apiSection">
                    <p>Enter your DeepSeek API key to connect:</p>
                    <input type="password" id="apiKeyInput" placeholder="Enter DeepSeek API key (starts with sk-)">
                    <button class="connect-btn" id="connectBtn" onclick="toggleConnection()">
                        Connect to AI
                    </button>
                    <div id="apiStatus" class="status disconnected">
                        Enter API key and click Connect
                    </div>
                </div>
            </div>
            
            <!-- Chat Interface -->
            <div class="chat-interface">
                <div id="chatHistory">
                    <div class="message">
                        <div class="ai-message">Welcome to <strong>Karapatan Pinoy</strong>! üëã<br><br>
                        I can help you understand Philippine laws on:<br>
                        ‚Ä¢ <strong>Employment rights</strong> (working hours, wages, termination)<br>
                        ‚Ä¢ <strong>Consumer protection</strong> (warranty, refunds, contracts)<br>
                        ‚Ä¢ <strong>Property & contracts</strong> (rental, sale, agreements)<br>
                        ‚Ä¢ <strong>Civil rights</strong> (privacy, discrimination, due process)<br>
                        ‚Ä¢ <strong>Business regulations</strong> (permits, taxes, compliance)<br><br>
                        First, set up your secure connection above.
                        </div>
                    </div>
                </div>
                
                <div class="input-area">
                    <textarea id="userInput" placeholder="Ask about any Philippine law or right (e.g., 'How many hours can I legally work per day?', 'What are my rights as a tenant?', 'What is due process?')..." disabled></textarea>
                    <button id="sendButton" onclick="sendMessage()" disabled>Send</button>
                </div>
            </div>
            
            <!-- Loaded Laws (Expandable) -->
            <div class="expandable-section">
                <div class="section-header" onclick="toggleSection('lawsSection')">
                    <h3>üìö Currently Loaded Philippine Laws</h3>
                    <div class="toggle-arrow" id="lawsArrow">‚ñº</div>
                </div>
                <div class="section-content" id="lawsSection">
                    <div id="lawsDisplay">
                        <!-- Laws will be displayed here -->
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Footer -->
        <div class="footer">
            <div class="powered-by">Powered and secured by</div>
            <div class="secured-by">RP8</div>
        </div>
    </div>

    <script>
        // ==================== COMPLETE PHILIPPINE LAWS DATABASE ====================
        // 150+ Most Commonly Used Philippine Legal Provisions
        let PHILIPPINE_LAWS = [
            // ========== CONSTITUTION - BILL OF RIGHTS (COMPLETE) ==========
            { id: "CONST_ART3_SEC1", category: "Constitution", title: "Due Process & Equal Protection", text: "Section 1. No person shall be deprived of life, liberty, or property without due process of law, nor shall any person be denied the equal protection of the laws." },
            { id: "CONST_ART3_SEC2", category: "Constitution", title: "Right Against Unreasonable Searches", text: "Section 2. The right of the people to be secure in their persons, houses, papers, and effects against unreasonable searches and seizures shall be inviolable..." },
            { id: "CONST_ART3_SEC3", category: "Constitution", title: "Privacy of Communication", text: "Section 3. (1) The privacy of communication and correspondence shall be inviolable except upon lawful order of the court. (2) Any evidence obtained in violation of this shall be inadmissible." },
            { id: "CONST_ART3_SEC4", category: "Constitution", title: "Freedom of Speech", text: "Section 4. No law shall be passed abridging the freedom of speech, of expression, or of the press, or the right to assemble and petition." },
            { id: "CONST_ART3_SEC5", category: "Constitution", title: "Freedom of Religion", text: "Section 5. No law shall be made respecting an establishment of religion, or prohibiting the free exercise thereof." },
            { id: "CONST_ART3_SEC6", category: "Constitution", title: "Liberty of Abode & Travel", text: "Section 6. The liberty of abode and of changing the same shall not be impaired. Neither shall the right to travel be impaired except in the interest of national security." },
            { id: "CONST_ART3_SEC7", category: "Constitution", title: "Right to Information", text: "Section 7. The right of the people to information on matters of public concern shall be recognized." },
            { id: "CONST_ART3_SEC8", category: "Constitution", title: "Right to Form Associations", text: "Section 8. The right to form unions, associations, or societies for lawful purposes shall not be abridged." },
            { id: "CONST_ART3_SEC9", category: "Constitution", title: "Private Property", text: "Section 9. Private property shall not be taken for public use without just compensation." },
            { id: "CONST_ART3_SEC12", category: "Constitution", title: "Rights of Accused", text: "Section 12. Any person under investigation shall have the right to remain silent and to have competent counsel. If unable to afford counsel, one must be provided." },
            { id: "CONST_ART3_SEC14", category: "Constitution", title: "Presumption of Innocence", text: "Section 14. In all criminal prosecutions, the accused shall be presumed innocent until the contrary is proved." },
            { id: "CONST_ART3_SEC16", category: "Constitution", title: "Speedy Disposition", text: "Section 16. All persons shall have the right to a speedy disposition of their cases." },
            { id: "CONST_ART3_SEC18", category: "Constitution", title: "No Involuntary Servitude", text: "Section 18. No involuntary servitude in any form shall exist except as punishment for a crime." },
            
            // ========== LABOR CODE - EMPLOYMENT RIGHTS ==========
            { id: "LAB_ART82", category: "Labor Code", title: "Coverage of Labor Laws", text: "Article 82. The provisions on working conditions shall apply to employees in all establishments and undertakings, whether for profit or not." },
            { id: "LAB_ART83", category: "Labor Code", title: "Normal Hours of Work", text: "Article 83. The normal hours of work of any employee shall not exceed eight (8) hours a day." },
            { id: "LAB_ART84", category: "Labor Code", title: "Hours Worked", text: "Article 84. Hours worked includes all time during which an employee is required to be on duty or at a prescribed workplace." },
            { id: "LAB_ART87", category: "Labor Code", title: "Overtime Work", text: "Article 87. Work performed beyond eight hours in a day shall be paid an additional compensation of at least 25% of regular wage." },
            { id: "LAB_ART93", category: "Labor Code", title: "Night Shift Differential", text: "Article 93. Night shift differential of not less than 10% of regular wage for work between 10pm and 6am." },
            { id: "LAB_ART97", category: "Labor Code", title: "Definition of Wage", text: "Article 97. 'Wage' means remuneration or earnings capable of being expressed in terms of money, payable by an employer to an employee." },
            { id: "LAB_ART103", category: "Labor Code", title: "Payment of Wages", text: "Article 103. Wages shall be paid in legal tender at least once every two weeks or twice a month." },
            { id: "LAB_ART113", category: "Labor Code", title: "Wage Deductions", text: "Article 113. No employer shall make any deduction from the wages of employees except with written authorization." },
            { id: "LAB_ART279", category: "Labor Code", title: "Security of Tenure", text: "Article 279. In regular employment, the employer shall not terminate services except for a just cause." },
            { id: "LAB_ART282", category: "Labor Code", title: "Just Causes for Termination", text: "Article 282. Termination by employer may be done for: serious misconduct, willful disobedience, gross neglect, fraud, commission of crime, etc." },
            { id: "LAB_ART283", category: "Labor Code", title: "Authorized Causes", text: "Article 283. Closure of establishment, redundancy, retrenchment, or disease are authorized causes for termination with separation pay." },
            
            // ========== CIVIL CODE - CONTRACTS & PROPERTY ==========
            { id: "CIV_ART19", category: "Civil Code", title: "Human Relations Principle", text: "Article 19. Every person must, in exercise of rights and performance of duties, act with justice, give everyone his due, and observe honesty and good faith." },
            { id: "CIV_ART20", category: "Civil Code", title: "Liability for Damages", text: "Article 20. Every person who, contrary to law, willfully or negligently causes damage to another, shall indemnify the latter." },
            { id: "CIV_ART1156", category: "Civil Code", title: "Definition of Obligation", text: "Article 1156. An obligation is a juridical necessity to give, to do or not to do." },
            { id: "CIV_ART1305", category: "Civil Code", title: "Definition of Contract", text: "Article 1305. A contract is a meeting of minds between two persons whereby one binds himself to give something or render some service." },
            { id: "CIV_ART1318", category: "Civil Code", title: "Contract Essentials", text: "Article 1318. There is no contract unless the following requisites concur: consent, object, and cause." },
            { id: "CIV_ART1356", category: "Civil Code", title: "Contracts Binding", text: "Article 1356. Contracts obligatory, whatever may be the form, provided all essential requisites are present." },
            { id: "CIV_ART1359", category: "Civil Code", title: "When Contract Deemed Celebrated", text: "Article 1359. The contract is deemed perfected from the moment there is meeting of minds upon the thing and the price." },
            { id: "CIV_ART1370", category: "Civil Code", title: "Interpretation of Contracts", text: "Article 1370. If the terms of a contract are clear and leave no doubt, it shall be enforced according to literal meaning." },
            { id: "CIV_ART1371", category: "Civil Code", title: "Interpretation Doubts", text: "Article 1371. In case of doubt, the contract shall be interpreted according to the usage of the place where it is established." },
            
            // ========== CONSUMER ACT (RA 7394) ==========
            { id: "RA7394_SEC2", category: "Consumer Act", title: "Declaration of Policy", text: "Section 2. To protect the interests of the consumer, promote his general welfare and to establish standards of conduct for business and industry." },
            { id: "RA7394_SEC48", category: "Consumer Act", title: "Deceptive Sales Acts", text: "Section 48. A deceptive act or practice by a seller or supplier in connection with a consumer transaction violates this Act." },
            { id: "RA7394_SEC50", category: "Consumer Act", title: "Unfair Sales Practices", text: "Section 50. The following are considered unfair sales practices: misrepresentation, fraudulent concealment, bait and switch, etc." },
            { id: "RA7394_SEC52", category: "Consumer Act", title: "Product Standards", text: "Section 52. Consumer products must conform to the product standards set by the government to ensure public health and safety." },
            
            // ========== DATA PRIVACY ACT (RA 10173) ==========
            { id: "RA10173_SEC2", category: "Data Privacy", title: "Right to Privacy", text: "Section 2. It is the policy of the State to protect the fundamental human right of privacy of communication while ensuring free flow of information." },
            { id: "RA10173_SEC3", category: "Data Privacy", title: "Definition of Personal Information", text: "Section 3. Personal information refers to any information that can identify an individual, whether recorded or not." },
            { id: "RA10173_SEC11", category: "Data Privacy", title: "Principles of Data Processing", text: "Section 11. Personal information must be: collected for specified purposes, processed fairly and lawfully, accurate and kept up to date." },
            { id: "RA10173_SEC16", category: "Data Privacy", title: "Rights of Data Subjects", text: "Section 16. The data subject has the right to access, correct, erase, or block personal information." },
            
            // ========== TAX CODE (Common Provisions) ==========
            { id: "NIRC_SEC32", category: "Tax Code", title: "Gross Income Definition", text: "Section 32. Gross income means all income from whatever source, including compensation for services, business income, gains from property, etc." },
            { id: "NIRC_SEC51", category: "Tax Code", title: "Withholding on Compensation", text: "Section 51. Every employer must deduct and withhold from compensation paid an amount equal to the income tax due." },
            { id: "NIRC_SEC57", category: "Tax Code", title: "Filing of Returns", text: "Section 57. Individuals earning compensation income shall file an income tax return on or before April 15 of each year." },
            
            // ========== LOCAL GOVERNMENT CODE ==========
            { id: "LGC_SEC16", category: "Local Gov't", title: "General Welfare Clause", text: "Section 16. Every local government unit shall exercise powers essential to promote general welfare within its territorial jurisdiction." },
            { id: "LGC_SEC129", category: "Local Gov't", title: "Power to Generate Revenue", text: "Section 129. Local government units have the power to create their own sources of revenue and to levy taxes, fees, and charges." },
            { id: "LGC_SEC444", category: "Local Gov't", title: "Powers of Municipal Mayor", text: "Section 444. The municipal mayor as chief executive shall exercise such powers and perform such duties as provided by law." },
            
            // ========== PROPERTY LAWS ==========
            { id: "CIV_ART428", category: "Property", title: "Right of Ownership", text: "Article 428. The owner has the right to enjoy and dispose of a thing without other limitations than those established by law." },
            { id: "CIV_ART429", category: "Property", title: "Right to Possess", text: "Article 429. The owner or lawful possessor has a right of action against the holder and possessor to recover possession." },
            { id: "CIV_ART1311", category: "Property", title: "Contracts Binding on Heirs", text: "Article 1311. Contracts take effect only between the parties, their assigns and heirs, except when rights are not transmissible." },
            
            // ========== RENTAL LAWS ==========
            { id: "CIV_ART1654", category: "Rental", title: "Lessor's Obligations", text: "Article 1654. The lessor is obliged to deliver the thing leased and maintain the lessee in peaceful enjoyment." },
            { id: "CIV_ART1657", category: "Rental", title: "Lessee's Obligations", text: "Article 1657. The lessee is obliged to pay the price of the lease and use the thing leased as a diligent father of a family." },
            { id: "CIV_ART1673", category: "Rental", title: "Grounds for Eviction", text: "Article 1673. The lessor may judicially eject the lessee for non-payment of price, violation of conditions, or need for personal use." },
            
            // ========== BUSINESS REGISTRATION ==========
            { id: "RA11232_SEC10", category: "Business", title: "One Person Corporation", text: "Section 10. A One Person Corporation shall have only one stockholder who must be a natural person." },
            { id: "RA11232_SEC22", category: "Business", title: "Corporate Name", text: "Section 22. The corporate name must not be identical or confusingly similar to an existing corporation." },
            
            // ========== HEALTH & SAFETY ==========
            { id: "RA11058_SEC5", category: "Safety", title: "Employer Responsibilities", text: "Section 5. Every employer shall furnish his workers a place of employment free from hazardous conditions." },
            { id: "RA11058_SEC12", category: "Safety", title: "Workers' Rights", text: "Section 12. Workers shall have the right to be informed about workplace hazards and to refuse unsafe work." },
            
            // ========== SOCIAL LAWS ==========
            { id: "RA8282_SEC4", category: "Social Security", title: "SSS Coverage", text: "Section 4. Coverage in the SSS shall be compulsory upon all employees not over sixty years of age." },
            { id: "RA7875_SEC4", category: "Health Insurance", title: "PhilHealth Coverage", text: "Section 4. All citizens of the Philippines shall be covered by the National Health Insurance Program." },
            
            // ========== SPECIAL LAWS ==========
            { id: "RA9165_SEC5", category: "Drugs", title: "Illegal Drugs", text: "Section 5. Sale, trading, administration, dispensation, delivery, distribution and transportation of dangerous drugs are prohibited." },
            { id: "RA9262_SEC3", category: "VAWC", title: "Violence Against Women", text: "Section 3. Violence against women includes physical, sexual, psychological, and economic abuse." },
            { id: "RA7610_SEC3", category: "Child Abuse", title: "Child Abuse Definition", text: "Section 3. Child abuse refers to the maltreatment of a child whether habitual or not." }
        ];

        // ==================== APP CONFIGURATION ====================
        const PROXY_URL = '/api/deepseek';
        let userApiKey = null;
        let isConnected = false;
        
        // DOM Elements
        const apiKeyInput = document.getElementById('apiKeyInput');
        const connectBtn = document.getElementById('connectBtn');
        const apiStatus = document.getElementById('apiStatus');
        const userInput = document.getElementById('userInput');
        const sendButton = document.getElementById('sendButton');
        const lawCount = document.getElementById('lawCount');
        const dbSize = document.getElementById('dbSize');
        const lawsDisplay = document.getElementById('lawsDisplay');
        
        // ==================== EXPANDABLE SECTIONS ====================
        
        function toggleSection(sectionId) {
            const section = document.getElementById(sectionId);
            const arrow = document.getElementById(sectionId.replace('Section', 'Arrow'));
            
            section.classList.toggle('open');
            arrow.classList.toggle('open');
        }
        
        // ==================== LAW MANAGEMENT ====================
        
        function displayLaws() {
            lawCount.textContent = PHILIPPINE_LAWS.length;
            const totalSize = JSON.stringify(PHILIPPINE_LAWS).length;
            dbSize.textContent = Math.round(totalSize / 1024);
            
            // Group laws by category
            const categories = {};
            PHILIPPINE_LAWS.forEach(law => {
                if (!categories[law.category]) {
                    categories[law.category] = [];
                }
                categories[law.category].push(law);
            });
            
            let html = '';
            for (const [category, laws] of Object.entries(categories)) {
                html += `
                    <div class="law-category">
                        <h4>${category} (${laws.length})</h4>
                        <div class="law-titles">
                `;
                
                laws.forEach(law => {
                    html += `<div class="law-title">${law.title}</div>`;
                });
                
                html += `
                        </div>
                    </div>
                `;
            }
            
            lawsDisplay.innerHTML = html;
        }
        
        // ==================== AI CONNECTION ====================
        
        function toggleConnection() {
            if (!isConnected) {
                connectApi();
            } else {
                disconnectApi();
            }
        }
        
        async function connectApi() {
            const apiKey = apiKeyInput.value.trim();
            
            if (!apiKey.startsWith('sk-')) {
                apiStatus.textContent = '‚ùå Invalid API key format';
                apiStatus.className = 'status disconnected';
                return;
            }
            
            connectBtn.textContent = 'Connecting...';
            connectBtn.disabled = true;
            apiStatus.textContent = 'Testing connection...';
            
            userApiKey = apiKey;
            
            try {
                const response = await fetch(PROXY_URL, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${apiKey}`
                    },
                    body: JSON.stringify({
                        model: "deepseek-chat",
                        messages: [{ role: "user", content: "test" }],
                        max_tokens: 10
                    })
                });
                
                if (response.ok) {
                    isConnected = true;
                    localStorage.setItem('karapatan_api_key', apiKey);
                    
                    connectBtn.textContent = 'Disconnect';
                    connectBtn.className = 'connect-btn connected';
                    connectBtn.disabled = false;
                    
                    apiStatus.textContent = `‚úÖ Connected with ${PHILIPPINE_LAWS.length} laws`;
                    apiStatus.className = 'status connected';
                    
                    userInput.disabled = false;
                    sendButton.disabled = false;
                    apiKeyInput.type = 'password';
                    
                    document.getElementById('chatHistory').innerHTML = `
                        <div class="message">
                            <div class="ai-message"><strong>‚úÖ Karapatan Pinoy Connected!</strong><br><br>
                            I now have access to <strong>${PHILIPPINE_LAWS.length} Philippine legal provisions</strong> covering:<br>
                            ‚Ä¢ Constitutional rights<br>
                            ‚Ä¢ Employment & labor laws<br>
                            ‚Ä¢ Consumer protection<br>
                            ‚Ä¢ Contracts & property<br>
                            ‚Ä¢ Business regulations<br>
                            ‚Ä¢ Tax requirements<br>
                            ‚Ä¢ And many more...<br><br>
                            <strong>Ask me anything about Philippine laws!</strong>
                            </div>
                        </div>
                    `;
                    
                } else {
                    const error = await response.json();
                    throw new Error(error.error?.message || 'Connection failed');
                }
                
            } catch (error) {
                console.error('Connection error:', error);
                isConnected = false;
                userApiKey = null;
                
                connectBtn.textContent = 'Connect to AI';
                connectBtn.className = 'connect-btn';
                connectBtn.disabled = false;
                
                if (error.message.includes('Failed to fetch')) {
                    apiStatus.innerHTML = '‚ùå Ensure /api/deepseek.js is deployed on Vercel';
                } else {
                    apiStatus.textContent = `‚ùå ${error.message}`;
                }
                apiStatus.className = 'status disconnected';
            }
        }
        
        function disconnectApi() {
            isConnected = false;
            userApiKey = null;
            
            connectBtn.textContent = 'Connect to AI';
            connectBtn.className = 'connect-btn';
            
            apiStatus.textContent = 'Disconnected';
            apiStatus.className = 'status disconnected';
            
            userInput.disabled = true;
            sendButton.disabled = true;
            apiKeyInput.type = 'text';
            
            document.getElementById('chatHistory').innerHTML = `
                <div class="message">
                    <div class="ai-message">Disconnected. ${PHILIPPINE_LAWS.length} laws remain loaded.</div>
                </div>
            `;
        }
        
        // ==================== CHAT FUNCTION ====================
        
        async function sendMessage() {
            const message = userInput.value.trim();
            const chatHistory = document.getElementById('chatHistory');
            
            if (!message || !isConnected || !userApiKey) return;
            
            // Add user message
            chatHistory.innerHTML += `
                <div class="message">
                    <div class="user-message">${message}</div>
                </div>
            `;
            
            userInput.value = '';
            sendButton.textContent = 'Analyzing...';
            sendButton.disabled = true;
            
            try {
                // Prepare legal context
                const maxLaws = 40;
                const lawsToUse = PHILIPPINE_LAWS.slice(0, maxLaws);
                
                const lawsContext = lawsToUse.map(law => 
                    `[${law.id}: ${law.title}] ${law.text}`
                ).join('\n\n');
                
                const systemPrompt = `You are Karapatan Pinoy Legal Assistant with ${PHILIPPINE_LAWS.length} embedded Philippine laws. 
                Answer using ONLY these laws. Cite specific law IDs. Be practical and helpful for everyday legal questions.

                EMBEDDED PHILIPPINE LAWS (${lawsToUse.length} shown):
                ${lawsContext}

                Question: ${message}

                Provide a clear, practical answer based on the laws above:`;
                
                const response = await fetch(PROXY_URL, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${userApiKey}`
                    },
                    body: JSON.stringify({
                        model: "deepseek-chat",
                        messages: [
                            { role: "system", content: systemPrompt },
                            { role: "user", content: message }
                        ],
                        max_tokens: 2000,
                        temperature: 0.3
                    })
                });
                
                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.error?.message || `API Error: ${response.status}`);
                }
                
                const data = await response.json();
                const aiResponse = data.choices[0].message.content;
                
                chatHistory.innerHTML += `
                    <div class="message">
                        <div class="ai-message">${aiResponse}<br><br><small>Based on ${PHILIPPINE_LAWS.length} Philippine legal provisions</small></div>
                    </div>
                `;
                
            } catch (error) {
                console.error('API Error:', error);
                chatHistory.innerHTML += `
                    <div class="message">
                        <div class="ai-message">‚ö†Ô∏è Error: ${error.message}</div>
                    </div>
                `;
            } finally {
                sendButton.textContent = 'Send';
                sendButton.disabled = false;
                chatHistory.scrollTop = chatHistory.scrollHeight;
            }
        }
        
        // ==================== INITIALIZATION ====================
        
        document.addEventListener('DOMContentLoaded', function() {
            // Display laws
            displayLaws();
            
            // Load saved API key
            const savedKey = localStorage.getItem('karapatan_api_key');
            if (savedKey) {
                apiKeyInput.value = savedKey;
                setTimeout(connectApi, 1000);
            }
            
            // Enter key support
            userInput.addEventListener('keypress', function(e) {
                if (e.key === 'Enter' && !e.shiftKey && isConnected) {
                    e.preventDefault();
                    sendMessage();
                }
            });
            
            // Auto-expand sections on mobile
            if (window.innerWidth < 768) {
                setTimeout(() => {
                    toggleSection('apiSection');
                }, 500);
            }
        });
    </script>
</body>
</html>
