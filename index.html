<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Philippine Legal AI Assistant</title>
    <style>
        /* Mobile CSS - keep your existing styles */
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body { font-family: -apple-system, BlinkMacSystemFont, sans-serif; background: #f5f7fa; }
        
        .container { max-width: 800px; margin: 0 auto; padding: 20px; }
        
        .header { 
            background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%); 
            color: white; padding: 25px; text-align: center; border-radius: 15px; margin-bottom: 20px;
        }
        
        .api-panel { 
            background: white; padding: 25px; border-radius: 15px; box-shadow: 0 4px 12px rgba(0,0,0,0.08); margin-bottom: 20px;
        }
        
        .status { padding: 15px; border-radius: 10px; margin: 15px 0; text-align: center; font-weight: 600; }
        .connected { background: #d4edda; color: #155724; }
        .disconnected { background: #f8d7da; color: #721c24; }
        
        #apiKeyInput { width: 100%; padding: 16px; margin: 10px 0; border: 2px solid #d1d9e6; border-radius: 10px; }
        .action-btn { width: 100%; padding: 17px; background: #1e3c72; color: white; border: none; border-radius: 10px; font-weight: 600; cursor: pointer; }
        
        .chat-interface { background: white; padding: 25px; border-radius: 15px; margin-bottom: 20px; }
        #chatHistory { height: 300px; overflow-y: auto; padding: 15px; background: #f8f9fa; border-radius: 10px; margin-bottom: 15px; }
        .user-message { background: #1e3c72; color: white; padding: 12px; border-radius: 15px; margin-left: auto; max-width: 80%; margin-bottom: 10px; }
        .ai-message { background: white; border: 1px solid #e1e5eb; padding: 12px; border-radius: 15px; max-width: 80%; margin-bottom: 10px; }
        
        #userInput { width: 100%; padding: 15px; border: 2px solid #d1d9e6; border-radius: 10px; min-height: 60px; resize: none; }
        #sendButton { width: 100%; padding: 16px; background: #1e3c72; color: white; border: none; border-radius: 10px; font-weight: 600; cursor: pointer; margin-top: 10px; }
        
        .proxy-info { background: #e7f3ff; padding: 15px; border-radius: 10px; margin-top: 20px; border-left: 5px solid #1e3c72; }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üáµüá≠ Philippine Legal AI</h1>
            <p>With Serverless Proxy - CORS Fixed</p>
        </div>
        
        <div class="api-panel">
            <h3>üîë API Configuration</h3>
            <p>Using serverless proxy: <code id="proxyUrl">/api/deepseek</code></p>
            <input type="text" id="apiKeyInput" placeholder="Enter DeepSeek API key" value="sk-27ddf66de4914457af0bdbe1db8cd549">
            <button class="action-btn" onclick="connectApi()">Connect via Proxy</button>
            <div id="apiStatus" class="status disconnected">Not Connected</div>
        </div>
        
        <div class="chat-interface">
            <div id="chatHistory">
                <div class="ai-message">Enter API key and click Connect. Using serverless proxy to avoid CORS.</div>
            </div>
            <textarea id="userInput" placeholder="Ask about Philippine law..." disabled></textarea>
            <button id="sendButton" onclick="sendMessage()" disabled>Send via Proxy</button>
        </div>
        
        <div class="proxy-info">
            <h4>‚úÖ How the Proxy Fixes CORS:</h4>
            <p><strong>Browser</strong> ‚Üí <strong>Vercel Proxy</strong> ‚Üí <strong>DeepSeek API</strong></p>
            <p>Your API key travels through your Vercel function, not directly from browser.</p>
        </div>
    </div>

    <script>
        // Configuration - USING YOUR VERCEL PROXY
        const PROXY_URL = '/api/deepseek'; // Relative path to your Vercel function
        let userApiKey = null;
        let isConnected = false;
        
        // Display current proxy URL
        document.getElementById('proxyUrl').textContent = window.location.origin + PROXY_URL;
        
        function connectApi() {
            const apiKey = document.getElementById('apiKeyInput').value.trim();
            const statusDiv = document.getElementById('apiStatus');
            
            if (apiKey.startsWith('sk-')) {
                userApiKey = apiKey;
                isConnected = true;
                
                statusDiv.textContent = '‚úÖ Connected via Vercel Proxy';
                statusDiv.className = 'status connected';
                document.getElementById('userInput').disabled = false;
                document.getElementById('sendButton').disabled = false;
                
                document.getElementById('chatHistory').innerHTML = `
                    <div class="ai-message">‚úÖ Connected! Proxy is active. Ask about divorce, annulment, or any Philippine law.</div>
                `;
            } else {
                statusDiv.textContent = '‚ùå Invalid API key format';
                statusDiv.className = 'status disconnected';
            }
        }
        
        async function sendMessage() {
            const input = document.getElementById('userInput');
            const message = input.value.trim();
            const chatHistory = document.getElementById('chatHistory');
            
            if (!message || !isConnected) return;
            
            // Add user message
            chatHistory.innerHTML += `
                <div class="user-message">${message}</div>
            `;
            
            input.value = '';
            const sendButton = document.getElementById('sendButton');
            sendButton.textContent = 'Thinking...';
            sendButton.disabled = true;
            
            try {
                // Philippine laws database (embedded in frontend)
                const PHILIPPINE_LAWS = [
                    { id: "FAM_1", text: "Marriage is a special contract of permanent union between a man and a woman entered into in accordance with law. (Family Code, Article 1)" },
                    { id: "FAM_45", text: "Grounds for annulment include: (1) Lack of parental consent; (2) Insanity; (3) Fraud; (4) Force; (5) Impotence. (Family Code, Article 45)" }
                ];
                
                const lawsContext = PHILIPPINE_LAWS.map(law => law.text).join('\n\n');
                
                // Send to YOUR Vercel proxy (not directly to DeepSeek)
                const response = await fetch(PROXY_URL, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${userApiKey}`
                    },
                    body: JSON.stringify({
                        model: "deepseek-chat",
                        messages: [
                            { 
                                role: "system", 
                                content: `You are a Philippine legal expert. Reference these laws:\n${lawsContext}\n\nAnswer concisely with citations.`
                            },
                            { role: "user", content: message }
                        ],
                        max_tokens: 1000
                    })
                });
                
                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.error?.message || `Proxy error: ${response.status}`);
                }
                
                const data = await response.json();
                const aiResponse = data.choices[0].message.content;
                
                chatHistory.innerHTML += `
                    <div class="ai-message">${aiResponse}</div>
                `;
                
            } catch (error) {
                console.error('Proxy error:', error);
                chatHistory.innerHTML += `
                    <div class="ai-message">‚ö†Ô∏è Error: ${error.message}<br><br>
                    <strong>Ensure:</strong><br>
                    1. You deployed the <code>/api/deepseek.js</code> file<br>
                    2. Your Vercel project has the function<br>
                    3. Check Vercel logs for errors
                    </div>
                `;
            } finally {
                sendButton.textContent = 'Send via Proxy';
                sendButton.disabled = false;
                chatHistory.scrollTop = chatHistory.scrollHeight;
            }
        }
        
        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            // Enter key support
            document.getElementById('userInput').addEventListener('keypress', function(e) {
                if (e.key === 'Enter' && !e.shiftKey && isConnected) {
                    e.preventDefault();
                    sendMessage();
                }
            });
            
            // Auto-connect if key is present
            const apiKeyInput = document.getElementById('apiKeyInput');
            if (apiKeyInput.value.startsWith('sk-')) {
                setTimeout(connectApi, 1000);
            }
        });
    </script>
</body>
</html>
